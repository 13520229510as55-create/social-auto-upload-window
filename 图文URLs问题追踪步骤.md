# 图文URLs问题追踪步骤

## 问题现象
新建的图文保存后，`media_ids` 字段只有一个URL，而不是多个URL数组。

## 已部署的调试日志

已在后端 `/production/image-text` 接口添加详细日志，追踪数据流：

### 日志内容：
1. 接收到的完整请求数据
2. `urls` 字段的类型（是否为数组）
3. `urls` 字段的值
4. `urls` 数组的长度
5. 转换后的JSON字符串
6. 保存的记录ID

## 测试步骤

### 1. 创建新的图文任务

1. 访问生产中心：http://150.107.38.113:5409
2. 点击"创建新任务"
3. 选择"图文"类型
4. 填写完整的图文配置（确保会生成多张图片）
5. 提交任务

### 2. 实时查看日志

打开终端，执行：
```bash
ssh ubuntu@150.107.38.113
tail -f /home/ubuntu/social-auto-upload/logs/backend.log
```

**关注以下日志：**
```
[图文保存] 收到请求，完整数据: {...}
[图文保存] urls字段类型: <class 'list'>
[图文保存] urls字段值: ['url1', 'url2', ...]
[图文保存] urls数组长度: X
[图文保存] 转换后的JSON字符串: ["url1", "url2", ...]
[图文保存] ✅ 保存成功，记录ID: XX
[图文保存] 保存的urls数量: X
```

### 3. 检查数据库

查看最新保存的记录：
```bash
ssh ubuntu@150.107.38.113
sqlite3 /home/ubuntu/social-auto-upload/db/database.db
SELECT id, title, media_ids FROM production_image_text ORDER BY id DESC LIMIT 1;
```

**期望结果：**
```
52|标题|["url1", "url2", "url3"]
```

## 可能的问题原因

### 原因1：n8n只返回一个URL

**现象：**
- 日志显示 `urls数组长度: 1`
- `urls字段值` 只有一个元素

**原因：**
- n8n工作流配置问题
- n8n只生成了一张图
- n8n的数据处理逻辑错误

**解决方案：**
1. 检查n8n工作流配置
2. 确认图片生成数量设置
3. 检查n8n的输出节点

### 原因2：前端传递数据时出错

**现象：**
- 日志显示 `urls` 不是数组
- 或者 `urls` 是空数组

**原因：**
- 前端 webhook 返回的数据格式不对
- 前端解析 `media_ids` 时出错

**解决方案：**
1. 检查前端控制台日志
2. 查看 `console.log('💾 保存图文记录到后端，urls数组:', urls)`
3. 确认 webhook 返回的 `result.media_ids` 是什么

### 原因3：数据库读取时解析错误

**现象：**
- 保存时日志显示多个URL
- 但读取时只显示一个URL

**原因：**
- 后端 `list_production_records` 解析逻辑错误

**解决方案：**
1. 检查后端的记录列表接口
2. 确认 JSON 解析是否正确

## 前端调试

在浏览器控制台查看日志：

### 创建图文任务时：
```
📤 制作中心图文任务 webhook payload: {...}
✅ 图文任务 webhook 调用成功: {...}
💾 保存图文记录到后端，urls数组: [...]
```

### 关键检查点：
1. `result.media_ids` 的值是什么？
2. 是否是数组？
3. 有多少个元素？

## n8n工作流检查

如果n8n是问题根源，需要检查：

### 1. 图片生成节点
- 是否设置了生成多张图片
- 输出格式是否正确

### 2. 数据聚合节点
- 是否正确聚合了所有图片URL
- 输出是否是数组格式

### 3. HTTP请求节点
- 发送到后端的数据格式
- `urls` 字段是否是数组

### 4. 测试n8n输出
在n8n中添加调试节点，输出最终的payload：
```json
{
  "title": "...",
  "content": "...",
  "urls": ["url1", "url2", "url3"]  // 必须是数组
}
```

## 下一步行动

1. **先测试**：创建一个新的图文任务，查看日志
2. **定位问题**：根据日志确定是n8n、前端还是后端的问题
3. **修复问题**：针对性修复

## 联系我

测试完成后，请提供：
1. 完整的后端日志（`[图文保存]` 相关的所有行）
2. 前端控制台日志截图
3. 数据库中保存的 `media_ids` 内容

这样我才能准确定位问题并修复。
