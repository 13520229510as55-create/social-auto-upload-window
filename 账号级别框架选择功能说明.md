# 账号级别框架选择功能说明

## 🎯 功能概述

在账号管理页面的添加账号弹窗中，为视频号平台增加了自动化框架选择功能，用户可以选择使用 Playwright 或 Selenium 进行登录。

## 📋 修改内容

### 1. 前端修改（AccountManagement.vue）

#### 1.1 添加框架选择UI

在"Cookie类型"选择后添加了"自动化框架"选项（仅视频号平台显示）：

```vue
<!-- 自动化框架选择（仅视频号平台显示） -->
<el-form-item 
  v-if="dialogType === 'add' && accountForm.platform === '视频号' && accountForm.cookieType === 'scan'" 
  label="自动化框架" 
  prop="automationTool"
>
  <el-radio-group v-model="accountForm.automationTool" :disabled="sseConnecting">
    <el-radio label="playwright">Playwright（推荐）</el-radio>
    <el-radio label="selenium">Selenium（备选）</el-radio>
  </el-radio-group>
  <div style="margin-top: 8px; font-size: 12px; color: #909399;">
    <div>• Playwright: 现代化，性能更好</div>
    <div>• Selenium: 成熟稳定，兼容性强</div>
  </div>
</el-form-item>
```

**显示条件：**
- ✅ 仅在添加账号时显示（`dialogType === 'add'`）
- ✅ 仅视频号平台显示（`accountForm.platform === '视频号'`）
- ✅ 仅扫码登录时显示（`accountForm.cookieType === 'scan'`）

#### 1.2 表单数据模型

```javascript
const accountForm = reactive({
  // ... 其他字段
  automationTool: 'playwright', // 默认使用 Playwright
})
```

#### 1.3 SSE连接函数修改

```javascript
const connectSSE = (platform, name, automationTool = 'playwright') => {
  // ...
  
  // 对于视频号，添加 automationTool 参数
  let url = `${apiBaseUrl}/login?type=${type}&id=${encodeURIComponent(name)}`
  if (type === '2' && automationTool) {
    url += `&automation_tool=${automationTool}`
  }
  
  // ...
}
```

#### 1.4 提交表单时传递参数

```javascript
// 扫码登录：建立SSE连接（传递自动化框架选择）
connectSSE(accountForm.platform, accountForm.name, accountForm.automationTool)
```

### 2. 后端修改（sau_backend.py）

#### 2.1 登录API接收参数

```python
@app.route('/login')
def login():
    type = request.args.get('type')
    id = request.args.get('id')
    automation_tool = request.args.get('automation_tool', 'playwright')  # 新增
    
    print(f"[登录API] 自动化框架: {automation_tool}", flush=True)
    # ...
```

#### 2.2 传递参数到异步任务

```python
thread = threading.Thread(
    target=run_async_function, 
    args=(type, id, status_queue, browser_context_storage, automation_tool),  # 新增参数
    daemon=True
)
```

#### 2.3 异步任务函数处理

```python
def run_async_function(type, id, status_queue, browser_context_storage=None, automation_tool='playwright'):
    print(f"[异步任务] automation_tool: {automation_tool}", flush=True)
    
    if type == '2':  # 视频号
        # 设置环境变量
        import os
        original_tool = os.environ.get('AUTOMATION_TOOL')
        os.environ['AUTOMATION_TOOL'] = automation_tool
        
        # 执行登录
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        loop.run_until_complete(get_tencent_cookie(id, status_queue, browser_context_storage))
        loop.close()
        
        # 恢复环境变量
        if original_tool is not None:
            os.environ['AUTOMATION_TOOL'] = original_tool
        elif 'AUTOMATION_TOOL' in os.environ:
            del os.environ['AUTOMATION_TOOL']
```

## 🔄 工作流程

```
用户操作
    ↓
选择平台 → 视频号
    ↓
选择Cookie类型 → 扫码登录
    ↓
显示框架选择 → Playwright / Selenium
    ↓
用户选择框架
    ↓
点击确认 → 提交表单
    ↓
前端建立SSE连接 → URL包含 automation_tool 参数
    ↓
后端接收参数 → 设置环境变量 AUTOMATION_TOOL
    ↓
login_wrapper.py 读取环境变量
    ↓
根据选择调用对应的登录函数
    ├─ playwright → login.py (get_tencent_cookie)
    └─ selenium → login_selenium.py (get_tencent_cookie_selenium)
    ↓
登录完成 → 清理环境变量
```

## 🎨 UI展示

### 添加账号弹窗

```
┌─────────────────────────────────────┐
│         添加账号                      │
├─────────────────────────────────────┤
│                                       │
│  平台:        [视频号 ▼]             │
│                                       │
│  名称:        [_________]             │
│                                       │
│  Cookie类型:  ○ 本地上传              │
│              ● 扫码登录               │
│                                       │
│  自动化框架:  ● Playwright（推荐）     │
│              ○ Selenium（备选）       │
│              • Playwright: 现代化，性能更好  │
│              • Selenium: 成熟稳定，兼容性强  │
│                                       │
│              [取消]  [确认]            │
└─────────────────────────────────────┘
```

## 📊 功能特点

### 1. 智能显示

- ✅ 仅视频号平台显示（其他平台不显示）
- ✅ 仅扫码登录时显示（本地上传Cookie不需要）
- ✅ 仅添加账号时显示（编辑账号不显示）

### 2. 默认值

- ✅ 默认选择 Playwright（推荐选项）
- ✅ 符合大多数用户需求

### 3. 账号级别控制

- ✅ 每个账号可以独立选择框架
- ✅ 不影响全局配置
- ✅ 不同账号可以使用不同框架

### 4. 环境变量隔离

- ✅ 为每次登录单独设置环境变量
- ✅ 登录完成后恢复原环境变量
- ✅ 多个登录请求互不干扰

## 🔍 技术细节

### 1. 环境变量处理

```python
# 保存原环境变量
original_tool = os.environ.get('AUTOMATION_TOOL')

# 设置本次登录的框架
os.environ['AUTOMATION_TOOL'] = automation_tool

# 执行登录
# ...

# 恢复环境变量
if original_tool is not None:
    os.environ['AUTOMATION_TOOL'] = original_tool
else:
    del os.environ['AUTOMATION_TOOL']
```

### 2. login_wrapper.py 读取

```python
from conf import AUTOMATION_TOOL  # 从环境变量或配置文件读取

async def get_tencent_cookie_unified(...):
    if AUTOMATION_TOOL == 'selenium':
        from myUtils.login_selenium import get_tencent_cookie_selenium
        # ...
    else:
        from myUtils.login import get_tencent_cookie
        # ...
```

### 3. 参数传递链路

```
前端表单
    accountForm.automationTool
        ↓
SSE连接URL
    ?automation_tool=playwright
        ↓
后端API参数
    request.args.get('automation_tool')
        ↓
异步任务参数
    run_async_function(..., automation_tool)
        ↓
环境变量
    os.environ['AUTOMATION_TOOL']
        ↓
配置读取
    AUTOMATION_TOOL (conf.py)
        ↓
登录函数选择
    get_tencent_cookie_unified
```

## 📝 使用示例

### 场景1：使用 Playwright（默认）

1. 打开添加账号弹窗
2. 选择平台：视频号
3. 输入账号名称
4. Cookie类型：扫码登录
5. 自动化框架：**Playwright（推荐）** ← 默认已选中
6. 点击确认
7. 扫码登录

### 场景2：使用 Selenium（备选）

1. 打开添加账号弹窗
2. 选择平台：视频号
3. 输入账号名称
4. Cookie类型：扫码登录
5. 自动化框架：切换到 **Selenium（备选）**
6. 点击确认
7. 扫码登录

### 场景3：本地上传Cookie

1. 打开添加账号弹窗
2. 选择平台：视频号
3. 输入账号名称
4. Cookie类型：**本地上传**
5. ⚠️ 自动化框架选项**不显示**（不需要）
6. 上传Cookie文件
7. 点击确认

## 🎯 优势

### 1. 用户友好

- ✅ 清晰的选项说明
- ✅ 合理的默认值
- ✅ 智能的显示逻辑

### 2. 灵活性

- ✅ 账号级别控制
- ✅ 不影响其他账号
- ✅ 可以混用两种框架

### 3. 可靠性

- ✅ 环境变量隔离
- ✅ 自动清理
- ✅ 多账号并发安全

### 4. 可扩展性

- ✅ 易于添加新框架
- ✅ 可以扩展到其他平台
- ✅ 配置灵活

## 🧪 测试建议

### 测试用例

1. **基本功能测试**
   - [ ] 选择 Playwright，登录成功
   - [ ] 选择 Selenium，登录成功
   - [ ] 默认值是 Playwright
   - [ ] 选项正确显示提示文本

2. **显示逻辑测试**
   - [ ] 非视频号平台不显示
   - [ ] 本地上传不显示
   - [ ] 编辑账号不显示
   - [ ] 扫码登录+视频号显示

3. **并发测试**
   - [ ] 同时添加多个账号
   - [ ] 使用不同框架
   - [ ] 环境变量正确隔离

4. **异常测试**
   - [ ] Selenium 未安装时的处理
   - [ ] 网络断开时的处理
   - [ ] 登录超时的处理

## ⚠️ 注意事项

### 1. Selenium 依赖

使用 Selenium 前需要安装：

```bash
./install_selenium.sh
```

### 2. 环境变量范围

- 环境变量仅在当前登录请求有效
- 登录完成后自动恢复
- 不影响全局配置

### 3. 兼容性

- 向后兼容：未选择时默认 Playwright
- 不影响现有账号
- 可以与全局配置共存

## 🔗 相关文档

1. **Playwright_vs_Selenium使用指南.md** - 两种框架对比
2. **Selenium版本实现总结.md** - Selenium 实现细节
3. **login_wrapper.py** - 统一登录入口

## ✅ 总结

### 核心价值

1. **用户控制** - 用户可以为每个账号选择最适合的框架
2. **灵活性** - 不同账号可以使用不同框架
3. **可靠性** - 环境变量隔离，互不干扰
4. **易用性** - 清晰的UI，合理的默认值

### 技术亮点

1. **前后端协同** - 参数传递完整
2. **环境隔离** - 使用临时环境变量
3. **智能显示** - 条件渲染，减少干扰
4. **向后兼容** - 不影响现有功能

---

**现在用户可以在添加视频号账号时，选择使用 Playwright 还是 Selenium 进行登录！** 🎉
