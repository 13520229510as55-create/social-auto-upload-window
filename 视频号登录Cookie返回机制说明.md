# è§†é¢‘å·ç™»å½•Cookieè¿”å›æœºåˆ¶è¯´æ˜

## âš ï¸ é‡è¦è¯´æ˜ï¼šå¾®ä¿¡ä¸æ˜¯é€šè¿‡APIæ¥å£è¿”å›Cookie

**å…³é”®ç†è§£**ï¼šå¾®ä¿¡è§†é¢‘å·ç™»å½•æ—¶ï¼ŒCookie**ä¸æ˜¯é€šè¿‡æŸä¸ªAPIæ¥å£è¿”å›çš„**ï¼Œè€Œæ˜¯é€šè¿‡**HTTPå“åº”å¤´ä¸­çš„Set-Cookie**è‡ªåŠ¨è®¾ç½®åˆ°æµè§ˆå™¨ä¸­çš„ã€‚

### Cookieè®¾ç½®çš„æœºåˆ¶

```
ç”¨æˆ·æ‰«ç ç¡®è®¤ç™»å½•
    â†“
å¾®ä¿¡æœåŠ¡å™¨éªŒè¯æ‰«ç 
    â†“
å¾®ä¿¡æœåŠ¡å™¨é€šè¿‡HTTPå“åº”å¤´è®¾ç½®Cookie
    â†“
Set-Cookie: session_id=xxx; Domain=.weixin.qq.com; Path=/
Set-Cookie: token=yyy; Domain=.weixin.qq.com; Path=/
Set-Cookie: ... (å¤šä¸ªCookie)
    â†“
æµè§ˆå™¨è‡ªåŠ¨æ¥æ”¶å¹¶ä¿å­˜è¿™äº›Cookie
    â†“
Cookieå­˜å‚¨åœ¨æµè§ˆå™¨çš„contextä¸­
    â†“
åç«¯é€šè¿‡Playwright APIè·å–Cookie
```

## å®Œæ•´ç™»å½•æµç¨‹

### 1. å‰ç«¯å‘èµ·ç™»å½•è¯·æ±‚
```
å‰ç«¯ â†’ GET /login?type=2&id=è´¦å·åç§°
     â†“
åç«¯å¯åŠ¨SSEæµï¼ˆServer-Sent Eventsï¼‰
```

### 2. åç«¯å¯åŠ¨æµè§ˆå™¨å¹¶è®¿é—®è§†é¢‘å·ç™»å½•é¡µ
```python
# ä½ç½®ï¼šmyUtils/login.py - get_tencent_cookie()
browser = await playwright.chromium.launch()
context = await browser.new_context()
page = await context.new_page()
await page.goto("https://channels.weixin.qq.com")
```

### 3. è·å–äºŒç»´ç å¹¶è¿”å›ç»™å‰ç«¯
```python
# æŸ¥æ‰¾iframeä¸­çš„äºŒç»´ç å›¾ç‰‡
iframe_locator = page.frame_locator("iframe").first
img_locator = iframe_locator.get_by_role("img").first
src = await img_locator.get_attribute("src")  # è·å–base64å›¾ç‰‡

# é€šè¿‡SSEæµè¿”å›ç»™å‰ç«¯
status_queue.put(src)  # æ ¼å¼: "data:image/png;base64,..."
```

### 4. ç”¨æˆ·æ‰«ç 
- ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡APPæ‰«æäºŒç»´ç 
- å¾®ä¿¡APPéªŒè¯æ‰«ç 
- **å…³é”®**ï¼šç”¨æˆ·ç‚¹å‡»"ç¡®è®¤ç™»å½•"åï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šé€šè¿‡HTTPå“åº”å¤´è®¾ç½®Cookie

### 5. Cookieå¦‚ä½•åˆ°è¾¾æµè§ˆå™¨ï¼ˆæ ¸å¿ƒæœºåˆ¶ï¼‰

**å¾®ä¿¡æœåŠ¡å™¨çš„è¡Œä¸º**ï¼š
```
ç”¨æˆ·æ‰«ç ç¡®è®¤åï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šï¼š
1. ç”Ÿæˆç™»å½•å‡­è¯ï¼ˆsession tokenç­‰ï¼‰
2. åœ¨HTTPå“åº”å¤´ä¸­è®¾ç½®Set-Cookie
   Set-Cookie: session_id=xxx; Domain=.weixin.qq.com; Path=/
   Set-Cookie: token=yyy; Domain=.weixin.qq.com; Path=/
   ... (å¤šä¸ªCookie)
3. æµè§ˆå™¨è‡ªåŠ¨æ¥æ”¶å¹¶ä¿å­˜è¿™äº›Cookie
```

**æµè§ˆå™¨è‡ªåŠ¨å¤„ç†**ï¼š
- æµè§ˆå™¨æ”¶åˆ°HTTPå“åº”å¤´ä¸­çš„`Set-Cookie`åï¼Œ**è‡ªåŠ¨ä¿å­˜**åˆ°æµè§ˆå™¨çš„Cookieå­˜å‚¨ä¸­
- è¿™äº›Cookieä¼šä¿å­˜åœ¨`context`ï¼ˆæµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼‰ä¸­
- **ä¸éœ€è¦ä»»ä½•APIæ¥å£**ï¼Œè¿™æ˜¯HTTPåè®®çš„æ ‡å‡†è¡Œä¸º

**ä»£ç ä¸­çš„ç›‘å¬æœºåˆ¶**ï¼š
- **ç½‘ç»œè¯·æ±‚ç›‘å¬**ï¼šä»£ç ä¸­æ³¨å†Œäº†å“åº”ç›‘å¬å™¨ï¼ˆ`page.on("response", handle_response)`ï¼‰
- **ç›‘å¬ä½ç½®**ï¼š`myUtils/login.py` ç¬¬814-890è¡Œ
- **ç›‘å¬å†…å®¹**ï¼šæ£€æµ‹æ‰€æœ‰å¾®ä¿¡åŸŸåä¸‹çš„HTTPå“åº”ï¼Œè®°å½•`Set-Cookie`å“åº”å¤´
- **è¯¦ç»†æ—¥å¿—è¾“å‡º**ï¼š
  ```
  [è§†é¢‘å·ç™»å½•] ğŸª ========== æ£€æµ‹åˆ°Set-Cookieå“åº”å¤´ ==========
  [è§†é¢‘å·ç™»å½•] ğŸª æ—¶é—´: 2025-12-14 21:09:30
  [è§†é¢‘å·ç™»å½•] ğŸª è¯·æ±‚URL: https://channels.weixin.qq.com/...
  [è§†é¢‘å·ç™»å½•] ğŸª è¯·æ±‚æ–¹æ³•: GET/POST
  [è§†é¢‘å·ç™»å½•] ğŸª å“åº”çŠ¶æ€: 200 OK
  [è§†é¢‘å·ç™»å½•] ğŸª Set-Cookieæ•°é‡: 3
  [è§†é¢‘å·ç™»å½•] ğŸª è¯´æ˜: å¾®ä¿¡æœåŠ¡å™¨é€šè¿‡HTTPå“åº”å¤´Set-Cookieè®¾ç½®äº†Cookie
  [è§†é¢‘å·ç™»å½•] ğŸª æµè§ˆå™¨ä¼šè‡ªåŠ¨æ¥æ”¶å¹¶ä¿å­˜è¿™äº›Cookieåˆ°contextä¸­
  [è§†é¢‘å·ç™»å½•] ğŸª Cookie 1: session_id=xxx...
  [è§†é¢‘å·ç™»å½•] ğŸª     Domain: .weixin.qq.com
  [è§†é¢‘å·ç™»å½•] ğŸª     Path: /
  [è§†é¢‘å·ç™»å½•] ğŸª     è¿‡æœŸæ—¶é—´: Max-Age=3600
  [è§†é¢‘å·ç™»å½•] ğŸª     HttpOnly: True
  [è§†é¢‘å·ç™»å½•] ğŸª     Secure: True
  [è§†é¢‘å·ç™»å½•] ğŸª Cookie 2: token=yyy...
  [è§†é¢‘å·ç™»å½•] ğŸª     Domain: .weixin.qq.com
  [è§†é¢‘å·ç™»å½•] ğŸª     Path: /
  [è§†é¢‘å·ç™»å½•] ğŸª ==========================================
  ```

**Cookieå˜åŒ–æ£€æµ‹**ï¼š
- **æ£€æµ‹ä½ç½®**ï¼š`myUtils/login.py` ç¬¬1143-1184è¡Œ
- **æ£€æµ‹æ–¹å¼**ï¼šå®šæœŸæ£€æŸ¥Cookieæ•°é‡å˜åŒ–
- **æ—¥å¿—è¾“å‡º**ï¼š
  ```
  ğŸª [è§†é¢‘å·ç™»å½•] æ£€æµ‹åˆ°Cookieæ•°é‡å¢åŠ ï¼
  ğŸª [è§†é¢‘å·ç™»å½•]    ä¹‹å‰: X ä¸ªCookie
  ğŸª [è§†é¢‘å·ç™»å½•]    ç°åœ¨: Y ä¸ªCookie
  ğŸª [è§†é¢‘å·ç™»å½•]    æ–°å¢: Z ä¸ªCookie
  ğŸª [è§†é¢‘å·ç™»å½•]    è¯´æ˜: å¾®ä¿¡æœåŠ¡å™¨å¯èƒ½é€šè¿‡HTTPå“åº”å¤´Set-Cookieè®¾ç½®äº†æ–°Cookie
  ğŸª [è§†é¢‘å·ç™»å½•]    å½“å‰Cookieåç§°åˆ—è¡¨ï¼ˆå‰10ä¸ªï¼‰: [...]
  ```

**Set-CookieéªŒè¯æœºåˆ¶**ï¼ˆæ–°å¢ï¼‰ï¼š
- **éªŒè¯ç›®çš„**ï¼šç¡®è®¤å¾®ä¿¡æ˜¯å¦çœŸçš„é€šè¿‡HTTPå“åº”å¤´Set-Cookieè®¾ç½®äº†å‡­è¯
- **éªŒè¯ä½ç½®**ï¼š`myUtils/login.py` ç¬¬810-950è¡Œï¼ˆç›‘å¬å™¨ï¼‰å’Œç¬¬1100-1150è¡Œï¼ˆå®šæœŸéªŒè¯ï¼‰
- **éªŒè¯æµç¨‹**ï¼š
  1. **å®æ—¶ç›‘å¬**ï¼šç›‘å¬æ‰€æœ‰HTTPå“åº”ä¸­çš„Set-Cookieå¤´
  2. **ç«‹å³éªŒè¯**ï¼šæ£€æµ‹åˆ°Set-Cookieåï¼Œç«‹å³æ£€æŸ¥è¿™äº›Cookieæ˜¯å¦å·²è®¾ç½®åˆ°æµè§ˆå™¨contextä¸­
  3. **å®šæœŸéªŒè¯**ï¼šæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡CookieçŠ¶æ€ï¼Œå¯¹æ¯”Set-Cookieè®°å½•å’Œå®é™…Cookieå­˜å‚¨
  4. **æœ€ç»ˆæŠ¥å‘Š**ï¼šç™»å½•æˆåŠŸæˆ–å¤±è´¥æ—¶ï¼Œç”Ÿæˆå®Œæ•´çš„éªŒè¯æŠ¥å‘Š

- **éªŒè¯æŠ¥å‘Šç¤ºä¾‹**ï¼š
  ```
  [è§†é¢‘å·ç™»å½•] ğŸ“Š ========== Set-CookieéªŒè¯æŠ¥å‘Š ==========
  [è§†é¢‘å·ç™»å½•] ğŸ“Š ç™»å½•çŠ¶æ€: æˆåŠŸ/å¤±è´¥
  [è§†é¢‘å·ç™»å½•] ğŸ“Š æ€»è€—æ—¶: 45.32 ç§’
  [è§†é¢‘å·ç™»å½•] ğŸ“Š æ£€æµ‹åˆ°Set-Cookieå“åº”æ¬¡æ•°: 3
  [è§†é¢‘å·ç™»å½•] ğŸ“Š æ€»Set-Cookieæ•°é‡: 8
  [è§†é¢‘å·ç™»å½•] ğŸ“Š é¦–æ¬¡æ£€æµ‹åˆ°Set-Cookieæ—¶é—´: 12.45 ç§’ï¼ˆç™»å½•å¼€å§‹åï¼‰
  [è§†é¢‘å·ç™»å½•] ğŸ“Š æœ€ç»ˆæµè§ˆå™¨contextä¸­Cookieæ•°é‡: 15
  [è§†é¢‘å·ç™»å½•] ğŸ“Š Set-Cookieä¸­çš„Cookieåœ¨contextä¸­éªŒè¯: 8/8
  [è§†é¢‘å·ç™»å½•] ğŸ“Š éªŒè¯æˆåŠŸç‡: 100.0%
  [è§†é¢‘å·ç™»å½•] âœ… ç»“è®º: æ‰€æœ‰Set-Cookieä¸­çš„Cookieéƒ½å·²æˆåŠŸè®¾ç½®åˆ°æµè§ˆå™¨contextä¸­
  [è§†é¢‘å·ç™»å½•] ğŸ“Š ==========================================
  ```

- **éªŒè¯ç»“æœè¯´æ˜**ï¼š
  - âœ… **éªŒè¯æˆåŠŸ**ï¼šæ‰€æœ‰Set-Cookieä¸­çš„Cookieéƒ½å·²å‡ºç°åœ¨æµè§ˆå™¨contextä¸­
  - âš ï¸ **éƒ¨åˆ†æˆåŠŸ**ï¼šéƒ¨åˆ†Set-Cookieä¸­çš„Cookieå·²è®¾ç½®ï¼Œä¼šåˆ—å‡ºæœªæ‰¾åˆ°çš„Cookie
  - âŒ **éªŒè¯å¤±è´¥**ï¼šSet-Cookieä¸­çš„Cookieå‡æœªå‡ºç°åœ¨æµè§ˆå™¨contextä¸­
  - âŒ **æœªæ£€æµ‹åˆ°Set-Cookie**ï¼šæ•´ä¸ªç™»å½•è¿‡ç¨‹ä¸­æœªæ£€æµ‹åˆ°ä»»ä½•Set-Cookieå“åº”å¤´

### 6. åç«¯æ£€æµ‹ç™»å½•æˆåŠŸ

åç«¯é€šè¿‡**ä¸‰ç§æ–¹å¼**æ£€æµ‹ç™»å½•æ˜¯å¦æˆåŠŸï¼š

#### æ–¹å¼1ï¼šæ£€æµ‹URLå˜åŒ–
```python
# ä½ç½®ï¼šmyUtils/login.py ç¬¬971-1001è¡Œ
current_url = page.url
if current_url != original_url:
    if "channels.weixin.qq.com/platform" in current_url:
        # URLå·²è·³è½¬åˆ°platformé¡µé¢ï¼Œè¯´æ˜ç™»å½•æˆåŠŸ
        login_detected = True
```

#### æ–¹å¼2ï¼šå®šæœŸä¿å­˜å¹¶éªŒè¯Cookie
```python
# ä½ç½®ï¼šmyUtils/login.py ç¬¬1036-1118è¡Œ
# æ¯10ç§’æ‰§è¡Œä¸€æ¬¡
await context.storage_state(path=temp_cookie_path)  # ä¿å­˜æ‰€æœ‰Cookieåˆ°æ–‡ä»¶
result = await check_cookie(2, cookie_filename)     # éªŒè¯Cookieæ˜¯å¦æœ‰æ•ˆ
if result:
    login_detected = True
```

#### æ–¹å¼3ï¼šæ£€æµ‹äºŒç»´ç æ¶ˆå¤±
```python
# ä½ç½®ï¼šmyUtils/login.py ç¬¬1144-1171è¡Œ
# å¦‚æœäºŒç»´ç å›¾ç‰‡ä¸å¯è§ï¼Œå¯èƒ½å·²ç»æ‰«ç æˆåŠŸ
is_visible = await img_locator.is_visible()
if not is_visible:
    # ä¿å­˜Cookieå¹¶éªŒè¯
    await context.storage_state(path=temp_cookie_path)
    result = await check_cookie(2, cookie_filename)
```

### 7. è·å–Cookieçš„æ–¹å¼

åç«¯é€šè¿‡**Playwrightçš„API**è·å–æµè§ˆå™¨ä¸­çš„Cookieï¼š

#### æ–¹å¼Aï¼šä»æµè§ˆå™¨ä¸Šä¸‹æ–‡è¯»å–
```python
# ä½ç½®ï¼šmyUtils/login.py ç¬¬1064è¡Œ
cookies = await context.cookies()
# è¿”å›æ‰€æœ‰Cookieçš„åˆ—è¡¨
```

#### æ–¹å¼Bï¼šä¿å­˜storage_stateåˆ°æ–‡ä»¶
```python
# ä½ç½®ï¼šmyUtils/login.py ç¬¬1044è¡Œ
await context.storage_state(path=temp_cookie_path)
# ä¿å­˜æ‰€æœ‰Cookieå’ŒlocalStorageåˆ°JSONæ–‡ä»¶
# æ–‡ä»¶æ ¼å¼ï¼š
# {
#   "cookies": [
#     {"name": "session_id", "value": "xxx", "domain": ".weixin.qq.com", ...},
#     ...
#   ],
#   "origins": [...]
# }
```

### 8. Cookieè¿”å›ç»™å‰ç«¯çš„ä¸¤ç§æ–¹å¼

#### æ–¹å¼1ï¼šé€šè¿‡SSEæµè‡ªåŠ¨è¿”å›ï¼ˆæ­£å¸¸æµç¨‹ï¼‰
```python
# ä½ç½®ï¼šmyUtils/login.py ç¬¬1327-1332è¡Œ
cookie_data = {
    "cookies": cookies,
    "filePath": f"{uuid_v1}.json",
    "userName": id
}
cookie_json = json.dumps(cookie_data, ensure_ascii=False)
status_queue.put(f"cookie:{cookie_json}")  # é€šè¿‡SSEæµå‘é€
```

å‰ç«¯æ¥æ”¶ï¼š
```javascript
// ä½ç½®ï¼šsau_frontend/src/views/AccountManagement.vue ç¬¬1289-1304è¡Œ
if (data.startsWith('cookie:')) {
    const cookieJson = data.substring(7)
    const cookieData = JSON.parse(cookieJson)
    // å¤„ç†Cookieæ•°æ®
}
```

#### æ–¹å¼2ï¼šé€šè¿‡æ‰‹åŠ¨ç¡®è®¤æ¥å£è¿”å›ï¼ˆç”¨æˆ·ç‚¹å‡»"æˆ‘å·²æ‰«ç å¹¶ç¡®è®¤"ï¼‰
```python
# ä½ç½®ï¼šsau_backend.py ç¬¬3228-3234è¡Œ
# æ¥å£ï¼šPOST /manualConfirmLogin?type=2&id=è´¦å·åç§°
return jsonify({
    "code": 200,
    "msg": "ç™»å½•ç¡®è®¤æˆåŠŸ",
    "data": {
        "filePath": f"{uuid_v1}.json"  # Cookieæ–‡ä»¶è·¯å¾„
    }
})
```

## Cookieè·å–çš„å®Œæ•´æµç¨‹ï¼ˆæ‰‹åŠ¨ç¡®è®¤ç™»å½•ï¼‰

å½“ç”¨æˆ·ç‚¹å‡»"æˆ‘å·²æ‰«ç å¹¶ç¡®è®¤"æ—¶ï¼Œè°ƒç”¨æ¥å£ï¼š`POST /manualConfirmLogin?type=2&id=è´¦å·åç§°`

### æ­¥éª¤1ï¼šæ£€æŸ¥å·²ä¿å­˜çš„cookies
```python
# ä½ç½®ï¼šsau_backend.py ç¬¬3081-3083è¡Œ
cookies = browser_context.get('cookies')
cookies_ready = browser_context.get('cookies_ready', False)
temp_cookie_path = browser_context.get('temp_cookie_path')
```
**æ—¥å¿—**ï¼š`[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] å½“å‰çŠ¶æ€ - cookies_ready: ..., cookiesæ•°é‡: ..., temp_cookie_path: ...`

### æ­¥éª¤2ï¼šä»ä¸´æ—¶Cookieæ–‡ä»¶è¯»å–
```python
# ä½ç½®ï¼šsau_backend.py ç¬¬3102-3116è¡Œ
if temp_cookie_path and os.path.exists(temp_cookie_path):
    with open(temp_cookie_path, 'r') as f:
        storage_data = json.load(f)
        cookies = storage_data.get('cookies', [])
```
**æ—¥å¿—**ï¼š`[+] ä»ä¸´æ—¶Cookieæ–‡ä»¶è¯»å–cookiesæˆåŠŸï¼ˆå…±Xä¸ªcookiesï¼‰`

### æ­¥éª¤3ï¼šä¸»åŠ¨ä»æµè§ˆå™¨ä¸Šä¸‹æ–‡è¯»å–ï¼ˆå…³é”®æ­¥éª¤ï¼‰
```python
# ä½ç½®ï¼šsau_backend.py ç¬¬3118-3200è¡Œ

# 3.1 å…ˆä¿å­˜storage_stateåˆ°ä¸´æ—¶æ–‡ä»¶
await context.storage_state(path=temp_cookie_path)
# æ—¥å¿—ï¼š[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤2: storage_stateå·²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶

# 3.2 ä»æ–‡ä»¶ä¸­è¯»å–cookies
with open(temp_cookie_path, 'r') as f:
    storage_data = json.load(f)
    cookies_from_file = storage_data.get('cookies', [])
# æ—¥å¿—ï¼š[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤3: ä»storage_stateæ–‡ä»¶è¯»å–cookiesæˆåŠŸï¼

# 3.3 å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ï¼Œä»contextç›´æ¥è¯»å–
if not cookies:
    cookies = await context.cookies()
# æ—¥å¿—ï¼š[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤4: ä»æµè§ˆå™¨ä¸Šä¸‹æ–‡è¯»å–cookiesæˆåŠŸï¼
```

### æ­¥éª¤4ï¼šä¿å­˜åˆ°æœ€ç»ˆæ–‡ä»¶
```python
# ä½ç½®ï¼šsau_backend.py ç¬¬3195-3234è¡Œ
storage_state = {
    "cookies": cookies,
    "origins": []
}
with open(cookie_path, 'w') as f:
    json.dump(storage_state, f)
# æ—¥å¿—ï¼š[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤7: Cookieæ–‡ä»¶å†™å…¥æˆåŠŸ
```

## å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯å‘èµ·ç™»å½•è¯·æ±‚                                          â”‚
â”‚    GET /login?type=2&id=è´¦å·åç§°                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åç«¯å¯åŠ¨SSEæµï¼Œå¯åŠ¨æµè§ˆå™¨                                 â”‚
â”‚    - åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰                             â”‚
â”‚    - è®¿é—® https://channels.weixin.qq.com                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è·å–äºŒç»´ç å¹¶è¿”å›ç»™å‰ç«¯                                    â”‚
â”‚    - é€šè¿‡SSEæµå‘é€: data:image/png;base64,...               â”‚
â”‚    - å‰ç«¯æ˜¾ç¤ºäºŒç»´ç                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç”¨æˆ·æ‰«ç å¹¶ç¡®è®¤                                            â”‚
â”‚    - å¾®ä¿¡APPæ‰«æäºŒç»´ç                                        â”‚
â”‚    - ç”¨æˆ·åœ¨APPä¸­ç‚¹å‡»"ç¡®è®¤ç™»å½•"                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å¾®ä¿¡æœåŠ¡å™¨è®¾ç½®Cookieï¼ˆå…³é”®æ­¥éª¤ï¼‰                          â”‚
â”‚    HTTPå“åº”å¤´:                                               â”‚
â”‚    Set-Cookie: session_id=xxx; Domain=.weixin.qq.com        â”‚
â”‚    Set-Cookie: token=yyy; Domain=.weixin.qq.com             â”‚
â”‚    ...                                                       â”‚
â”‚    â†“                                                         â”‚
â”‚    æµè§ˆå™¨è‡ªåŠ¨ä¿å­˜Cookieåˆ°contextä¸­                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åç«¯æ£€æµ‹ç™»å½•æˆåŠŸï¼ˆä¸‰ç§æ–¹å¼ï¼‰                              â”‚
â”‚    - æ–¹å¼1: URLå˜åŒ–æ£€æµ‹ï¼ˆæœ€å¿«ï¼‰                              â”‚
â”‚      URLä» login.html â†’ platform/...                        â”‚
â”‚    - æ–¹å¼2: CookieéªŒè¯ï¼ˆæ¯10ç§’ï¼‰                            â”‚
â”‚      await context.storage_state() â†’ check_cookie()         â”‚
â”‚    - æ–¹å¼3: äºŒç»´ç æ¶ˆå¤±æ£€æµ‹ï¼ˆè¾…åŠ©ï¼‰                          â”‚
â”‚      äºŒç»´ç å›¾ç‰‡ä¸å¯è§ â†’ ä¿å­˜Cookieå¹¶éªŒè¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è·å–Cookieï¼ˆä¸¤ç§æ–¹å¼ï¼‰                                    â”‚
â”‚    - æ–¹å¼A: context.cookies()                               â”‚
â”‚      ç›´æ¥è¯»å–Cookieåˆ—è¡¨                                      â”‚
â”‚    - æ–¹å¼B: context.storage_state()                         â”‚
â”‚      ä¿å­˜åˆ°æ–‡ä»¶ï¼Œç„¶åä»æ–‡ä»¶è¯»å–                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Cookieè¿”å›ç»™å‰ç«¯ï¼ˆä¸¤ç§æ–¹å¼ï¼‰                              â”‚
â”‚    - æ–¹å¼1: é€šè¿‡SSEæµè‡ªåŠ¨è¿”å›                                â”‚
â”‚      status_queue.put("cookie:{JSONæ•°æ®}")                   â”‚
â”‚    - æ–¹å¼2: é€šè¿‡æ‰‹åŠ¨ç¡®è®¤æ¥å£è¿”å›                              â”‚
â”‚      POST /manualConfirmLogin â†’ è¿”å›æ–‡ä»¶è·¯å¾„                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ç‚¹æ€»ç»“

### 1. Cookieä¸æ˜¯é€šè¿‡APIè¿”å›çš„
- å¾®ä¿¡é€šè¿‡HTTPå“åº”å¤´`Set-Cookie`è®¾ç½®Cookie
- æµè§ˆå™¨è‡ªåŠ¨æ¥æ”¶å¹¶ä¿å­˜
- **è¿™æ˜¯HTTPåè®®çš„æ ‡å‡†è¡Œä¸ºï¼Œä¸æ˜¯å¾®ä¿¡æä¾›çš„API**

### 2. Cookieå­˜å‚¨åœ¨æµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸­
- Playwrightçš„`context`å¯¹è±¡åŒ…å«äº†æ‰€æœ‰Cookie
- Cookieå­˜å‚¨åœ¨æµè§ˆå™¨çš„å†…å­˜ä¸­
- å¯ä»¥é€šè¿‡APIè¯»å–ï¼Œä½†ä¸èƒ½ç›´æ¥è®¿é—®æµè§ˆå™¨å†…éƒ¨å­˜å‚¨

### 3. è·å–Cookieçš„æ–¹å¼
- **`context.cookies()`** - ç›´æ¥è¯»å–Cookieåˆ—è¡¨ï¼ˆå¼‚æ­¥ï¼‰
- **`context.storage_state()`** - ä¿å­˜æ‰€æœ‰çŠ¶æ€åˆ°æ–‡ä»¶ï¼ˆåŒ…æ‹¬Cookieå’ŒlocalStorageï¼‰

### 4. Cookieè¿”å›ç»™å‰ç«¯çš„æ–¹å¼
- **æ­£å¸¸æµç¨‹**ï¼šé€šè¿‡SSEæµå‘é€ï¼ˆæ ¼å¼ï¼š`cookie:{JSONæ•°æ®}`ï¼‰
  - æ¥å£ï¼š`GET /login` (SSEæµ)
  - ä½ç½®ï¼š`myUtils/login.py` ç¬¬1335è¡Œ
- **æ‰‹åŠ¨ç¡®è®¤**ï¼šé€šè¿‡`/manualConfirmLogin`æ¥å£è¿”å›æ–‡ä»¶è·¯å¾„
  - æ¥å£ï¼š`POST /manualConfirmLogin?type=2&id=è´¦å·åç§°`
  - ä½ç½®ï¼š`sau_backend.py` ç¬¬3228-3234è¡Œ

### 5. æ£€æµ‹ç™»å½•æˆåŠŸçš„æ–¹å¼
- **URLå˜åŒ–æ£€æµ‹**ï¼ˆæœ€å¿«ï¼Œç¬¬971-1001è¡Œï¼‰
- **CookieéªŒè¯**ï¼ˆæœ€å¯é ï¼Œæ¯10ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œç¬¬1036-1118è¡Œï¼‰
- **äºŒç»´ç æ¶ˆå¤±æ£€æµ‹**ï¼ˆè¾…åŠ©ï¼Œç¬¬1145-1256è¡Œï¼‰

## å…³é”®ä»£ç ä½ç½®

### ç™»å½•æµç¨‹å…¥å£
- **å‰ç«¯å‘èµ·ç™»å½•**ï¼š`sau_frontend/src/views/AccountManagement.vue` ç¬¬1228è¡Œ
- **åç«¯ç™»å½•æ¥å£**ï¼š`sau_backend.py` ç¬¬3341è¡Œ `@app.route('/login')`
- **ç™»å½•å‡½æ•°**ï¼š`myUtils/login.py` ç¬¬762è¡Œ `async def get_tencent_cookie()`

### Cookieæ£€æµ‹å’Œè·å–
- **URLå˜åŒ–æ£€æµ‹**ï¼š`myUtils/login.py` ç¬¬971-1001è¡Œ
- **CookieéªŒè¯æ£€æµ‹**ï¼š`myUtils/login.py` ç¬¬1036-1118è¡Œ
- **äºŒç»´ç æ¶ˆå¤±æ£€æµ‹**ï¼š`myUtils/login.py` ç¬¬1145-1256è¡Œ
- **Cookieä¿å­˜åˆ°ä¸Šä¸‹æ–‡**ï¼š`myUtils/login.py` ç¬¬1061-1074è¡Œ

### Cookieè¿”å›ç»™å‰ç«¯
- **SSEæµå‘é€Cookie**ï¼š`myUtils/login.py` ç¬¬1335è¡Œ
- **SSEæµå¤„ç†**ï¼š`sau_backend.py` ç¬¬4057-4092è¡Œ
- **å‰ç«¯æ¥æ”¶Cookie**ï¼š`sau_frontend/src/views/AccountManagement.vue` ç¬¬1289-1306è¡Œ

### æ‰‹åŠ¨ç¡®è®¤ç™»å½•
- **æ‰‹åŠ¨ç¡®è®¤æ¥å£**ï¼š`sau_backend.py` ç¬¬2985è¡Œ `@app.route('/manualConfirmLogin')`
- **ä¸»åŠ¨è·å–Cookie**ï¼š`sau_backend.py` ç¬¬3118-3200è¡Œ
- **ä¿å­˜Cookieåˆ°æ–‡ä»¶**ï¼š`sau_backend.py` ç¬¬3195-3234è¡Œ

## é—®é¢˜æ’æŸ¥

å¦‚æœCookieè·å–å¤±è´¥ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **æ˜¯å¦çœŸçš„æ‰«ç å¹¶ç¡®è®¤äº†**
   - æ£€æŸ¥æ—¥å¿—ï¼š`âœ… æ£€æµ‹åˆ°URLå˜åŒ–ï¼Œç™»å½•æˆåŠŸ`
   - æ£€æŸ¥URLæ˜¯å¦è·³è½¬åˆ°`platform`é¡µé¢
   - ä»£ç ä½ç½®ï¼š`myUtils/login.py` ç¬¬976è¡Œ

2. **Cookieæ˜¯å¦çœŸçš„è¢«è®¾ç½®åˆ°æµè§ˆå™¨**
   - æ£€æŸ¥æ—¥å¿—ï¼š`ğŸ” åˆå§‹åŒ–Cookieè®¡æ•°: X`ï¼ˆåº”è¯¥>0ï¼‰
   - æ£€æŸ¥ä¸´æ—¶Cookieæ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥>1000å­—èŠ‚ï¼‰
   - ä»£ç ä½ç½®ï¼š`myUtils/login.py` ç¬¬1082è¡Œ

3. **æµè§ˆå™¨ä¸Šä¸‹æ–‡æ˜¯å¦è¿˜å­˜åœ¨**
   - æ£€æŸ¥æ—¥å¿—ï¼š`[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤0: æµè§ˆå™¨ä¸Šä¸‹æ–‡å­˜åœ¨`
   - å¦‚æœcontextä¸ºNoneï¼Œè¯´æ˜æµè§ˆå™¨å·²å…³é—­
   - ä»£ç ä½ç½®ï¼š`sau_backend.py` ç¬¬3122è¡Œ

4. **storage_stateæ–‡ä»¶æ˜¯å¦åŒ…å«cookies**
   - æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼š`{"cookies": [...], "origins": [...]}`
   - å¦‚æœcookiesæ•°ç»„ä¸ºç©ºï¼Œè¯´æ˜ç™»å½•æœªæˆåŠŸ
   - ä»£ç ä½ç½®ï¼š`sau_backend.py` ç¬¬3146-3150è¡Œ

5. **ä»contextè¯»å–æ˜¯å¦æˆåŠŸ**
   - æ£€æŸ¥æ—¥å¿—ï¼š`[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤4: ä»æµè§ˆå™¨ä¸Šä¸‹æ–‡è¯»å–cookiesæˆåŠŸï¼`
   - å¦‚æœå¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯
   - ä»£ç ä½ç½®ï¼š`sau_backend.py` ç¬¬3159-3175è¡Œ

## è°ƒè¯•å»ºè®®

1. **æŸ¥çœ‹å®Œæ•´æ—¥å¿—**ï¼š
   ```bash
   tail -f /home/ubuntu/social-auto-upload/logs/backend-out.log | grep -E 'æ‰‹åŠ¨ç¡®è®¤ç™»å½•|Cookie|cookies|æ­¥éª¤'
   ```

2. **æ£€æŸ¥ä¸´æ—¶Cookieæ–‡ä»¶**ï¼š
   ```bash
   ls -lh /home/ubuntu/social-auto-upload/cookiesFile/*.json | tail -5
   cat /home/ubuntu/social-auto-upload/cookiesFile/ä¸´æ—¶æ–‡ä»¶.json | jq '.cookies | length'
   ```

3. **æ£€æŸ¥æµè§ˆå™¨ä¸Šä¸‹æ–‡**ï¼š
   - æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰`[æ‰‹åŠ¨ç¡®è®¤ç™»å½•] âœ… æ­¥éª¤0: æµè§ˆå™¨ä¸Šä¸‹æ–‡å­˜åœ¨`
   - å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜æµè§ˆå™¨å·²å…³é—­ï¼Œéœ€è¦é‡æ–°å¼€å§‹ç™»å½•æµç¨‹
